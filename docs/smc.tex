\documentclass[11pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{bm}

\usepackage[round]{natbib}
\renewcommand{\bibname}{References}
\renewcommand{\bibsection}{\subsubsection*{\bibname}}
\renewcommand{\bibname}{References}
\bibliographystyle{apalike}

\newcommand{\reals}{\mathbb{R}}
\newcommand{\naturals}{\mathbb{N}}
\newcommand{\integers}{\mathbb{Z}}
\newcommand{\normal}{\mathcal{N}}
\newcommand{\unif}{\mathcal{U}}

\newcommand{\z}{\mathbf{z}}
\newcommand{\abold}{\mathbf{a}}
\newcommand{\y}{\mathbf{y}}
\newcommand\tdict[0]{\boldsymbol{\tau}}

\title{Sequential Monte Carlo Pseudomarginal Generative Functions}
\author{Marco Cusumano-Towner}

\begin{document}
\maketitle

\section{A generative model}
\noindent Consider a generative probabilistic model with joint distribution:
\[
p_{\theta}(\z_{1:T}, \y_{1:T}) = \left( p(z_1) \prod_{t=2}^T p(z_t | \z_{1:t-1})  \right) \left( \prod_{t=1}^T p(y_t | z_t) \right)
\]
for some parameter $\theta$.
We will omit the parameter from the notation from here forward to simplify notation.

\section{Particle filtering and conditional particle filtering}
Consider a family of proposal distributions:
\[
    k_1(z_1) \mbox{ and } k_t(z_t; \z_{1:t-1}) \mbox{ for } t \in \{2, \ldots, T\}
\]
Consider a particle filter with $N$ particles that uses the above proposal distributions at each time step, with proportional resampling at every time step.
Suppose after computing the weights at time step $T$, the particle filter resamples a single `distinguished' particle index proportionally to the weights.
Notation for the particle filter:
\begin{itemize}
    \item $z_t^{(i)}$ is the state for particle $i$ at time $t$, for $i \in \{1, \ldots, N\}$ and $t \in \{1, \ldots, T\}$.
    \item $a_{t-1}^{(i)} \in \{1, \ldots, N\}$ is the index of the parent of $z_t^{(i)}$ for $i \in \{1, \ldots, N\}$ and $t \in \{2, \ldots, T\}$.
    \item $I_T$ is the index of the distinguished particle at time $T$.
    \item $I_t := a_t^{(I_{t+1})}$ is the index of the distinguished particle at time $t$ for $t \in \{1, \ldots, T-1\}$.
    \item $\z_{1:T}^* = (z_1^{(I_1)}, z_2^{(I_2)}, \ldots, z_T^{(I_T)})$ is the distinguished particle.
    \item $w^{(i)}_1 := \displaystyle \frac{p(z_1, y_1)}{k_1(z_t)}$ is the initial weight, for $i \in \{1, \ldots, N\}$ and $t \in \{2, \ldots, T\}$.
    \item $w^{(i)}_t := \displaystyle \frac{p(z_t, y_t | \z_{1:t-1})}{k_t(z_t; \z_{1:t-1})}$ is an incremental weight, for $i \in \{1, \ldots, N\}$ and $t \in \{2, \ldots, T\}$.
    \item $\z_{1:T}^{1:N} := (z_t^{(i)})_{t \in \{1, \ldots, T\}}^{i \in 1 \ldots, N}$ is the set of all particles.
    \item $\abold_{1:T-1}^{1:N} := (a^{(i)}_{t-1})_{t \in \{2, \ldots, T\}}^{i \in \{1, \ldots, N\}}$ is the set of all ancestor choices.
\end{itemize}
The particle filter algorithm samples from the following joint distribution:
\begin{align*}
    & q_{\mathrm{SMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T, \z_{1:T}^*)\\
    &=  \left( \prod_{i=1}^N k_1(z_1^{(i)}) \right)
        \left( \prod_{t=2}^T \prod_{i=1}^N \frac{w_{t-1}^{(a_{t-1}^{(i)})}}{\sum_{j=1}^N w_{t-1}^{(j)}} k_t(z_t^{(i)}; \z_{1:t-1}^{(a_{t-1}^{(i)})} )\right)
        \left( \frac{w_T^{(I_T)}}{\sum_{j=1}^N w_T^{(j)}} \right)
        \delta(\z_{1:T}^*,  (z_1^{(I_1)}, \ldots, z_T^{(I_T)}))
\end{align*}
where $\delta$ denotes the Kronecker delta function, and where we assume the $z_{t}^i$ are discrete.
Given $\z_{1:T}^*$, the conditional particle filter algorithm samples from the following joint distribution:
\begin{align*}
    & r_{\mathrm{CSMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T; \z_{1:T}^*)\\
    &=  \delta(\z_{1:T}^*,  (z_1^{(I_1)}, \ldots, z_T^{(I_T)}))
        \frac{1}{N^T}
        \left( \prod_{\substack{i=1\\i \ne I_1}}^N k_1(z_1^{(i)}) \right)
        \left( \prod_{t=2}^T \prod_{\substack{i=1\\i \ne I_t}}^N \frac{w_{t-1}^{(a_{t-1}^{(i)})}}{\sum_{j=1}^N w_{t-1}^{(j)}} k_t(z_t^{(i)}; \z_{1:t-1}^{(a_{t-1}^{(i)})} )\right)
\end{align*}

\section{Constructing a generative function}
We combine the generative model and the particle filter and conditional particle filter algorithms together to construct a generative function.
We use the notation of Section 4.5 of~\citet{cusumano-towner-thesis}.
Without loss of generality, let the arguments to the generative function be $x = (\theta, T)$ (recall that $\theta$ parametrizes the generative model joint distribution).
For argument $(\theta, T)$ the generative function places all its probability mass on choice maps of the form:
\[
\tdict = \{1 \mapsto y_1, \ldots, T \mapsto y_T\}
\]
where the probability for such a choice map $\tdict$ in terms of the underlying generative model as:
\[
    p(\tdict; (\theta, T)) := \sum_{\z_{1:T}} p(\z_{1:T}, \y_{1:T}) = p(\y_{1:T})
\]
We now endow the generative function with encapsulated randomness of the form:
\[
\omega = (\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, \z_{1:T}^*)
\]
We define:
\begin{align*}
\mathring{p}(\omega; (\theta, T), \tdict) &:= p(\z_{1:T}^* | y_{1:T}) r_{\mathrm{CSMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T; \z_{1:T}^*)\\
\mathring{q}(\omega; (\theta, T), \tdict) &:= q_{\mathrm{SMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T, \z_{1:T}^*)
\end{align*}
Therefore:
\begin{align*}
\xi((\theta, T), \tdict, \omega)
    &:= \frac{p(\tdict; (\theta, T)) \mathring{p}(\omega; (\theta, T), \tdict)}{\mathring{q}(\omega; (\theta, T), \tdict)}\\
    &= \frac{p(\y_{1:T}) p(\z_{1:T}^* | y_{1:T}) r_{\mathrm{CSMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T; \z_{1:T}^*)}{q_{\mathrm{SMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T, \z_{1:T}^*)}\\
    &= \prod_{t=1}^T \frac{1}{N} \sum_{i=1}^N w^{(i)}_t
\end{align*}
which is the marginal likelihood estimate from the particle filter (see~\citet{cusumano2017aide} for the derivation for the more general setting of SMC samplers with rejuvenation).

\subsection{Simulate}
The \emph{simulate} operation jointly samples $\tdict \sim p(\cdot; (\theta, T))$ and $\omega | \tdict \sim \mathring{p}(\cdot; (\theta, T), \tdict)$.
It is possible to sample from this joint distribution by:
\begin{enumerate}
\item Sampling from the joint distribution of the underlying generative model: $\z_{1:T}^*, \y_{1:T} \sim p(\cdot)$.
\item Executing the conditional particle filter algorithm given input $\z_{1:T}^*$ (the algorithm depends on $\y_{1:T}$ as well), which together with $\z_{1:T}^*$ gives the encapsulated randomness $\omega$.
\end{enumerate}
After executing conditional particle filter, $\xi((\theta, T), \tdict, \omega)$ is the particle filter marginal likelihood estimate.
The operation returns a \emph{trace} containing this estimate along with $\y_{1:T}$ and $\omega$ and the arguments $(\theta, T)$.

\subsection{Generate}
We consider \emph{generate} operation acting on constraints $\tdict = \{1 \mapsto y_1, \ldots, T \mapsto y_T\}$ (it can be extended to handle other $\y_{1:T}$ via an internal proposal distribution family that sampels the subset of $\y_t$ that were not provided given those that were).
It samples $\omega \sim \mathring{q}(\cdot; (\theta, T), \tdict)$, which in our case reduces to executing the particle filter.
Then, $\xi((\theta, T), \tdict, \omega)$ is the particle filter marginal likelihood estimate.
The operation returns a trace containing this estimate along with $\y_{1:T}$ and $\omega$ and the arguments $(\theta, T)$, as well as a \emph{weight}, which in our case reduces to $\xi((\theta, T), \tdict, \omega)$.

\subsection{Update}

\subsubsection{Generalizing the operation}
The \emph{update} operation described in Section 4.5 of~\citet{cusumano-towner-thesis} samples fresh encapsulated randomness independently of the previous value of the encapsulated randomness, from $\mathring{q}$.
(It first computes $\tdict'$ from its inputs, but we do not discuss this process here. We assume $\tdict'$ has already been computed.)
For our example, this amounts to running the particle filter from scratch, which will typically scale as $O(T)$.
If the parameters $\theta$ did not change in the call to update, and if the time step $T$ was incremented by $1$, then re-running the particle filter from scratch is computationally onerous.
This is a common situation when e.g. running an SMC algorithm to infer the parameters $\theta$.
We now show how to instead extend the particle filter state, allowing for $O(1)$ scaling of update in these cases.

First, we introduce another family of auxiliary distributions into the generative function:
\[
\mathring{q}(\omega'; \omega, x, x', \tdict, \tdict')
\]
This is a family of probability distributions on $\omega'$, indexed by $(x, \tdict, \omega, x', \tdict')$ such that $p(\tdict; x) > 0$, $\mathring{p}(\omega; x, \tdict) > 0$, and $p(\tdict'; x') > 0$.
It must satisfy the following condition:
\[
\mathring{q}(\omega'; \omega, x, x', \tdict, \tdict') > 0 \iff \mathring{q}(\omega; \omega', x', x, \tdict', \tdict) > 0
\]
Then, we modify the following elements of the \emph{update} operation:
\begin{enumerate}
\item We sample $\omega'$ as $\omega' \sim \mathring{q}(\cdot; \omega, x, x', \tdict, \tdict')$
\item We return the following weight:
\[
\frac{p(\tdict'; x') \mathring{p}(\omega'; x', \tdict')\mathring{q}(\omega; \omega', x', x, \tdict', \tdict)}
{p(\tdict; x) \mathring{p}(\omega; x, \tdict) \mathring{q}(\omega'; \omega, x, x', \tdict, \tdict')}
\]
\end{enumerate}
Note that in the special case of:
\[
\mathring{q}(\omega'; \omega, x, x', \tdict, \tdict') = \mathring{q}(\omega'; x', \tdict')
\]
this reduces to the definition of \emph{update} given in~\citet{cusumano-towner-thesis}.

\subsubsection{Application to particle filter pseudomarginal generative functions}
For our case, let $T > 1$.
Let $x = (\theta, T)$ and $x' = (\theta, T+1)$, and 
$\tdict = \{1 \mapsto y_1, \ldots, T \mapsto y_T\}$ and 
$\tdict' = \{1 \mapsto y_1, \ldots, T \mapsto y_T, T + 1 \mapsto y_{T+1}\}$.
We define:
\begin{align*}
 \mathring{q}(\omega'; \omega, x, x', \tdict, \tdict')
    := \left( \prod_{i=1}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} ) \right)
        \left( \frac{{w'}_{T+1}^{(I'_{T+1})}}{\sum_{j=1}^N {w'}_{T+1}^{(j)}} \right)
\end{align*}
and 
\begin{align*}
 \mathring{q}(\omega; \omega', x', x, \tdict', \tdict)
    := \left( \frac{{w}_{T}^{(I_{T})}}{\sum_{j=1}^N {w}_{T}^{(j)}} \right)
\end{align*}
for $\omega, \omega'$ such that
${\z'}_{1:T}^{1:N} = {\z}_{1:T}^{1:N}$ and 
${\abold'}_{1:T-1}^{1:N} = {\abold}_{1:T-1}^{1:N}$
and zero otherwise.
In words, $\omega'$ is an extension of the particle system $(\z_{1:T-1}^{1:N}, \abold_{1:T-1}^{1:N})$, with new random variables ${\abold'}_{T}^{1:N}$ and ${\z'}_{T+1}^{1:N}$ sampled from the proposal distribution $k_{T+1}$.
The index $I_T$ of the previous distinguished particle is replaced with a new index $I_{T+1}'$, so that in general $\z_{1:T}^{*}$ and ${\z'}_{1:T+1}^{*}$ do not share common states.

The weight is then:
\begin{align*}
\frac{
    p({\z'}_{1:T+1}^*, \y_{1:T+1})
    r_{\mathrm{CSMC}}({\z'}_{1:T+1}^{1:N}, {\abold'}_{1:T}^{1:N}, I_{T+1}'; {\z'}_{1:T+1}^*)
    \left( \frac{{w}_{T}^{(I_{T})}}{\sum_{j=1}^N {w}_{T}^{(j)}} \right)
}{
    p(\z_{1:T}^*, \y_{1:T})
    r_{\mathrm{CSMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T; \z_{1:T}^*)
    \left( \prod_{i=1}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} ) \right)
    \left( \frac{{w'}_{T+1}^{(I'_{T+1})}}{\sum_{j=1}^N {w'}_{T+1}^{(j)}} \right)
}
\end{align*}

\begin{align*}
\frac{p({\z'}_{1:T+1}^*, \y_{1:T+1})}{{w'}_{T+1}^{(I'_{T+1})}}
    &= \frac{p({\z'}_{1:T+1}^*, \y_{1:T+1})}
            {\left(\frac{p({\z'}_{1:T+1}^*, \y_{1:T+1} | {\z'}_{1:T}^*)}{k_{T+1}({z'}_{T+1}^{*}; {\z'}_{1:T}^{*})}\right)}
    = k_{T+1}({z'}_{T+1}^{*}; {\z'}_{1:T}^{*}) p({\z'}_{1:T}^*)
\end{align*}

\begin{align*}
\frac{p({\z}_{1:T}^*, \y_{1:T})}{{w}_{T}^{(I_{T})}}
    &= \frac{p({\z}_{1:T}^*, \y_{1:T})}
            {\left(\frac{p({\z}_{1:T}^*, \y_{1:T} | {\z}_{1:T-1}^*)}{k_{T}({z}_{T}^{*}; {\z}_{1:T-1}^{*})}\right)}
    = k_{T}({z}_{T}^{*}; {\z}_{1:T-1}^{*}) p({\z}_{1:T-1}^*)
\end{align*}

\begin{align*}
& \frac{r_{\mathrm{CSMC}}({\z'}_{1:T+1}^{1:N}, {\abold'}_{1:T}^{1:N}, I_{T+1}'; {\z'}_{1:T+1}^*)}
{r_{\mathrm{CSMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T; \z_{1:T}^*)}\\
&= \frac{1}{N} \frac{
\delta({\z'}_{1:T+1}^*,  ({z'}_1^{(I'_1)}, \ldots, {z'}_{T+1}^{(I'_{T+1})}))
        \left( \prod_{\substack{i=1\\i \ne I'_1}}^N k_1({z'}_1^{(i)}) \right)
        \left( \prod_{t=2}^{T+1} \prod_{\substack{i=1\\i \ne I'_t}}^N \frac{{w'}_{t-1}^{({a'}_{t-1}^{(i)})}}{\sum_{j=1}^N {w'}_{t-1}^{(j)}} k_t({z'}_t^{(i)}; {\z'}_{1:t-1}^{({a'}_{t-1}^{(i)})} )\right)
}
{
\delta(\z_{1:T}^*,  (z_1^{(I_1)}, \ldots, z_T^{(I_T)}))
        \left( \prod_{\substack{i=1\\i \ne I_1}}^N k_1(z_1^{(i)}) \right)
        \left( \prod_{t=2}^T \prod_{\substack{i=1\\i \ne I_t}}^N \frac{w_{t-1}^{(a_{t-1}^{(i)})}}{\sum_{j=1}^N w_{t-1}^{(j)}} k_t(z_t^{(i)}; \z_{1:t-1}^{(a_{t-1}^{(i)})} )\right)
}\\
&= \frac{1}{N} \frac{
        \left( \prod_{\substack{i=1\\i \ne I'_1}}^N k_1({z'}_1^{(i)}) \right)
        \left( \prod_{t=2}^{T+1} \prod_{\substack{i=1\\i \ne I'_t}}^N \frac{{w'}_{t-1}^{({a'}_{t-1}^{(i)})}}{\sum_{j=1}^N {w'}_{t-1}^{(j)}} k_t({z'}_t^{(i)}; {\z'}_{1:t-1}^{({a'}_{t-1}^{(i)})} )\right)
}{
        \left( \prod_{\substack{i=1\\i \ne I_1}}^N k_1(z_1^{(i)}) \right)
        \left( \prod_{t=2}^T \prod_{\substack{i=1\\i \ne I_t}}^N \frac{w_{t-1}^{(a_{t-1}^{(i)})}}{\sum_{j=1}^N w_{t-1}^{(j)}} k_t(z_t^{(i)}; \z_{1:t-1}^{(a_{t-1}^{(i)})} )\right)
}
\end{align*}

\begin{align*}
\frac{
    \prod_{\substack{i=1\\i \ne I'_1}}^N k_1({z'}_1^{(i)})
}{
    \prod_{\substack{i=1\\i \ne I_1}}^N k_1(z_1^{(i)})
} =
\frac{
    k_1(z_1^{(I_1)}) \prod_{\substack{i=1}}^N k_1({z'}_1^{(i)})
}{
    k_1({z'}_1^{(I'_1)}) \prod_{\substack{i=1}}^N k_1(z_1^{(i)})
} =
\frac{
k_1(z_1^{(I_1)}) 
}{
k_1({z'}_1^{(I'_1)})
}
\end{align*}

\begin{align*}
&\frac{
\prod_{t=2}^{T+1} \prod_{\substack{i=1\\i \ne I'_t}}^N \frac{{w'}_{t-1}^{({a'}_{t-1}^{(i)})}}{\sum_{j=1}^N {w'}_{t-1}^{(j)}} k_t({z'}_t^{(i)}; {\z'}_{1:t-1}^{({a'}_{t-1}^{(i)})} )
}{
\prod_{t=2}^T \prod_{\substack{i=1\\i \ne I_t}}^N \frac{w_{t-1}^{(a_{t-1}^{(i)})}}{\sum_{j=1}^N w_{t-1}^{(j)}} k_t(z_t^{(i)}; \z_{1:t-1}^{(a_{t-1}^{(i)})} )
}\\ &=
\frac{
\displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
\prod_{t=2}^{T} \frac{{w}_{t-1}^{({a}_{t-1}^{(I_t)})}}{\sum_{j=1}^N {w}_{t-1}^{(j)}} k_t({z}_t^{(I_t)}; {\z}_{1:t-1}^{({a}_{t-1}^{(I_t)})} )
}{
\displaystyle \prod_{t=2}^{T} \frac{{w'}_{t-1}^{({a'}_{t-1}^{(I_t')})}}{\sum_{j=1}^N {w'}_{t-1}^{(j)}} k_t({z'}_t^{(I_t')}; {\z'}_{1:t-1}^{({a'}_{t-1}^{(I_t')})} )
}\\ &=
\frac{
\displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
\prod_{t=2}^{T} {w}_{t-1}^{({a}_{t-1}^{(I_t)})} k_t({z}_t^{(I_t)}; {\z}_{1:t-1}^{({a}_{t-1}^{(I_t)})} )
}{
\displaystyle \prod_{t=2}^{T} {w'}_{t-1}^{({a'}_{t-1}^{(I_t')})} k_t({z'}_t^{(I_t')}; {\z'}_{1:t-1}^{({a'}_{t-1}^{(I_t')})} )
}
\end{align*}

\begin{align*}
& \frac{r_{\mathrm{CSMC}}({\z'}_{1:T+1}^{1:N}, {\abold'}_{1:T}^{1:N}, I_{T+1}'; {\z'}_{1:T+1}^*)}
{r_{\mathrm{CSMC}}(\z_{1:T}^{1:N}, \abold_{1:T-1}^{1:N}, I_T; \z_{1:T}^*)}\\
&= 
\frac{1}{N} \frac{
k_1(z_1^{(I_1)}) \displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
\prod_{t=2}^{T} {w}_{t-1}^{({a}_{t-1}^{(I_t)})} k_t({z}_t^{(I_t)}; {\z}_{1:t-1}^{({a}_{t-1}^{(I_t)})} )
}{
k_1({z'}_1^{(I_1')}) \displaystyle \prod_{t=2}^{T} {w'}_{t-1}^{({a'}_{t-1}^{(I_t')})} k_t({z'}_t^{(I_t')}; {\z'}_{1:t-1}^{({a'}_{t-1}^{(I_t')})} )
}\\
&=
\frac{1}{N} \frac{
k_1(z_1^{(I_1)}) \displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
\prod_{t=2}^{T} {w}_{t-1}^{(I_{t-1})} k_t({z}_t^*; {\z}_{1:t-1}^{*} )
}{
k_1({z'}_1^{(I_1')}) \displaystyle \prod_{t=2}^{T} {w'}_{t-1}^{(I'_{t-1})} k_t({z'}_t^{*}; {\z'}_{1:t-1}^{*} )
}\\
&=
\frac{1}{N} \frac{
k_1(z_1^{(I_1)}) \displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
\prod_{t=2}^{T} \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{k_{t-1}(z_{t-1}^{*}; \z_{1:t-2}^{*})} k_t({z}_t^*; {\z}_{1:t-1}^{*} )
}{
k_1({z'}_1^{(I_1')}) \displaystyle \prod_{t=2}^{T} \frac{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}{k_{t-1}({z'}_{t-1}^*; {\z'}_{1:t-2}^{*})} k_t({z'}_t^{*}; {\z'}_{1:t-1}^{*} )
}\\
&=
\frac{1}{N} \frac{
k_1(z_1^{(I_1)}) \displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
\frac{k_T(z_T^*; \z_{1:T-1}^*)}{k_1(z_1^*)} \prod_{t=2}^{T} p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})
}{
k_1({z'}_1^{(I_1')}) \displaystyle \frac{k_T({z'}_T^*; {\z'}_{1:T-1}^*)}{k_1({z'}_1^*)} \prod_{t=2}^{T} p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)
}\\
&=
\frac{1}{N} \frac{
\left( \displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} ) \right)
k_T(z_T^*; \z_{1:T-1}^*)
\displaystyle \prod_{t=2}^{T} p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})
}{
\displaystyle k_T({z'}_T^*; {\z'}_{1:T-1}^*) \prod_{t=2}^{T} p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)
}
\end{align*}

Continuing with the weight:
\begin{align*}
&
\frac{1}{N} \frac{
k_{T+1}({z'}_{T+1}^*; {\z'}_{1:T}^*) 
}{
k_T(z_T^*; \z_{1:T-1}^*)
}
\frac{p({\z'}_{1:T}^*)}{p({\z}_{1:T-1}^*)}
\frac{
\sum_{j=1}^N {w'}_{T+1}^{(j)}
}{
\sum_{j=1}^N {w}_{T}^{(j)}
}
\frac{
\displaystyle \prod_{\substack{i=1\\i \ne I'_{T+1}}}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
}{
\displaystyle \prod_{i=1}^N \frac{{w'}_{T}^{({a'}_{T}^{(i)})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(i)}; {\z'}_{1:T}^{({a'}_{T}^{(i)})} )
}
\frac{
k_T(z_T^*; \z_{1:T-1}^*)
}{
k_T({z'}_T^*; {\z'}_{1:T-1}^*)
}
\prod_{t=2}^T \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}\\
&=
\frac{1}{N} \frac{
k_{T+1}({z'}_{T+1}^*; {\z'}_{1:T}^*)
}{
k_T({z'}_T^*; {\z'}_{1:T-1}^*)
}
\frac{p({\z'}_{1:T}^*)}{p({\z}_{1:T-1}^*)}
\frac{
\sum_{j=1}^N {w'}_{T+1}^{(j)}
}{
\sum_{j=1}^N {w}_{T}^{(j)}
}
\prod_{t=2}^T \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}
\frac{1}{
\frac{{w'}_{T}^{({a'}_{T}^{(I_{T+1}')})}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{(I_{T+1}')}; {\z'}_{1:T}^{({a'}_{T}^{(I_{T+1}')})} )
}\\
&=
\frac{
k_{T+1}({z'}_{T+1}^*; {\z'}_{1:T}^*)
}{
k_T({z'}_T^*; {\z'}_{1:T-1}^*)
}
\frac{p({\z'}_{1:T}^*)}{p({\z}_{1:T-1}^*)}
\frac{
\sum_{j=1}^N {w'}_{T+1}^{(j)}
}{
\sum_{j=1}^N {w}_{T}^{(j)}
}
\prod_{t=2}^T \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}
\frac{1}{
\frac{{w'}_{T}^{(I_T')}}{\sum_{j=1}^N {w'}_{T}^{(j)}} k_{T+1}({z'}_{T+1}^{*}; {\z'}_{1:T}^{*} )
}\\
&=
\frac{1}{N}
\frac{
k_{T+1}({z'}_{T+1}^*; {\z'}_{1:T}^*)
}{
k_T({z'}_T^*; {\z'}_{1:T-1}^*)
}
\frac{p({\z'}_{1:T}^*)}{p({\z}_{1:T-1}^*)}
\frac{
\sum_{j=1}^N {w'}_{T+1}^{(j)}
}{
1
}
\prod_{t=2}^T \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}
\frac{1}{
{w'}_{T}^{(I_T')} k_{T+1}({z'}_{T+1}^{*}; {\z'}_{1:T}^{*} )
}\\
&= \frac{
1
}{
k_T({z'}_T^*; {\z'}_{1:T-1}^*)
}
\frac{p({\z'}_{1:T}^*)}{p({\z}_{1:T-1}^*)}
\frac{
\sum_{j=1}^N {w'}_{T+1}^{(j)}
}{
1
}
\prod_{t=2}^T \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}
\frac{1}{
{w'}_{T}^{(I_T')}
}\\
&=
\frac{1}{N}
\frac{
1
}{
k_T({z'}_T^*; {\z'}_{1:T-1}^*)
}
\frac{p({\z'}_{1:T}^*)}{p({\z}_{1:T-1}^*)}
\frac{
\sum_{j=1}^N {w'}_{T+1}^{(j)}
}{
1
}
\prod_{t=2}^T \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}
\frac{
k_T({z'}_{T}^*; {\z'}_{1:T-1}^*)
}{
p({z'}_{T}^*, y_T| {\z'}_{1:T-1}^*)
}\\
&=
\frac{1}{N}
\frac{
\sum_{j=1}^N {w'}_{T+1}^{(j)}
}{
1
}
\frac{p({\z'}_{1:T}^*)}{p({\z}_{1:T-1}^*)}
\prod_{t=2}^T \frac{p(z_{t-1}^*, y_{t-1} | {\z}_{1:t-2}^{*})}{p({z'}_{t-1}^*, y_{t-1} | {\z'}_{1:t-2}^*)}
\frac{
1
}{
p({z'}_{T}^*, y_T| {\z'}_{1:T-1}^*)
}\\
&= \frac{p({\z}_{1:T-1}^*, y_{1:T-1})}{p({\z'}_{1:T}^*, y_{1:T})} \frac{1}{N} \sum_{j=1}^N {w'}_{T+1}^{(j)}
\end{align*}

% TODO explicitly relate to SMC^2
\bibliography{references} 

\end{document}
